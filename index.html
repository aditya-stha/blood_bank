<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blood Donor Finder</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tabletop@1.6.0/src/tabletop.min.js"></script>
<style>
  body { padding: 15px; font-family: Arial, sans-serif; background: #f9f9f9; }
  .donor-card { margin-bottom: 15px; }
  .badge-blood { font-size: 0.9rem; font-weight: bold; color: white; }
  .A+ { background: #ff4d4d; }
  .A- { background: #ff6666; }
  .B+ { background: #ffb366; }
  .B- { background: #ffd699; }
  .O+ { background: #66b3ff; }
  .O- { background: #99ccff; }
  .AB+ { background: #cc99ff; }
  .AB- { background: #d9b3ff; }
</style>
</head>
<body>

<div class="container">
  <h1 class="mb-3 text-center">Blood Donor Finder</h1>

  <div class="mb-3">
    <input type="text" id="bloodType" class="form-control" placeholder="Enter Blood Type e.g., O+">
    <button class="btn btn-primary mt-2 w-100" onclick="searchBlood()">Search Donors</button>
    <button class="btn btn-info mt-2 w-100" onclick="showAll()">Show All Donors</button>
  </div>

  <div id="results"></div>

  <button class="btn btn-success mt-4 w-100" onclick="register()">Register as Donor</button>
</div>

<script>
const publicSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwIRrdAwKRXOqoTfuj-O6aOBSideOlf54wIvI6v1CSJa31lg9E3RON7WqAv8yJaa5ApQprIVXIsY9Y/pubhtml?gid=450047681&single=true'; // Replace with your published form response sheet
let bloodData = [];
let keys = {}; // To store actual column keys

Tabletop.init({
  key: publicSpreadsheetUrl,
  simpleSheet: true,
  callback: function(data) {
    console.log('Raw sheet data:', data); // See what Tabletop reads
    if (data.length === 0) return;

    // Automatically detect column keys
    const firstRow = data[0];
    for (let k in firstRow) {
      if (k.toLowerCase().includes('name')) keys.name = k;
      if (k.toLowerCase().includes('phone')) keys.phone = k;
      if (k.toLowerCase().includes('blood')) keys.blood = k;
    }
    console.log('Detected keys:', keys);

    // Map data
    bloodData = data.map(d => ({
      Name: d[keys.name]?.trim() || '',
      Phone: d[keys.phone]?.trim() || '',
      BloodType: d[keys.blood]?.trim() || ''
    }));
    console.log('Mapped data:', bloodData);
  }
});

function showAll() {
  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  if (bloodData.length === 0) {
    resultsDiv.innerHTML = '<p class="text-center">No data loaded yet.</p>';
    return;
  }

  bloodData.forEach(d => {
    const card = document.createElement('div');
    card.className = 'card donor-card p-3 shadow-sm';
    card.innerHTML = `
      <h5>${d.Name} <span class="badge badge-blood ${d.BloodType.replace('+','plus').replace('-','minus')}">${d.BloodType}</span></h5>
      <p>Phone: <a href="tel:${d.Phone}">${d.Phone}</a></p>
    `;
    resultsDiv.appendChild(card);
  });
}

function searchBlood() {
  const typeInput = document.getElementById('bloodType').value.trim().toUpperCase();
  if (!typeInput) return alert('Please enter a blood type');

  const matches = bloodData.filter(d => d.BloodType.toUpperCase() === typeInput);

  const resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';

  if (matches.length === 0) {
    resultsDiv.innerHTML = '<p class="text-center">No donors found.</p>';
    return;
  }

  matches.forEach(d => {
    const card = document.createElement('div');
    card.className = 'card donor-card p-3 shadow-sm';
    card.innerHTML = `
      <h5>${d.Name} <span class="badge badge-blood ${d.BloodType.replace('+','plus').replace('-','minus')}">${d.BloodType}</span></h5>
      <p>Phone: <a href="tel:${d.Phone}">${d.Phone}</a></p>
    `;
    resultsDiv.appendChild(card);
  });
}

function register() {
  window.open("YOUR_GOOGLE_FORM_URL", "_blank");
}
</script>

</body>
</html>
